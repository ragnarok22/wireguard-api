#!/usr/bin/with-contenv sh
cd /app
# Restore default gateway if missing (linuxserver/wireguard might strip it)
# specific to Docker bridge networks where gateway is usually X.Y.Z.1
GATEWAY=$(ip route show | grep 'link src' | awk '{print $1}' | cut -d/ -f1 | awk -F. '{print $1"."$2"."$3".1"}')
ip route add default via $GATEWAY || true

# Bootstrap WireGuard if missing
if ! ip link show wg0 > /dev/null 2>&1; then
    echo "wg0 interface not found. Bootstrapping new WireGuard server..."
    
    # Check for persistent key
    KEY_FILE="/config/server_private.key"
    if [ -f "$KEY_FILE" ]; then
        echo "Loading server private key from $KEY_FILE"
        PRIVATE_KEY=$(cat "$KEY_FILE")
    else
        echo "Generating new server private key and saving to $KEY_FILE"
        PRIVATE_KEY=$(wg genkey)
        # Ensure /config exists (it should, as a volume)
        mkdir -p /config
        echo "$PRIVATE_KEY" > "$KEY_FILE"
    fi
    
    # Create interface manually
    ip link add dev wg0 type wireguard
    ip address add 10.13.13.1/24 dev wg0
    
    # Configure WireGuard
    # Create a temp file for the key because `wg set` expects a file or stdin
    echo "$PRIVATE_KEY" > /tmp/server.key
    wg set wg0 listen-port 51820 private-key /tmp/server.key
    rm /tmp/server.key
    
    ip link set up dev wg0
    echo "wg0 bootstrapped successfully!"
    
    # Enable IP forwarding
    sysctl -w net.ipv4.ip_forward=1
    
    # Enable NAT/Masquerading to access internet
    echo "Enabling NAT..."
    iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
    iptables -A FORWARD -i wg0 -j ACCEPT
    iptables -A FORWARD -o wg0 -j ACCEPT
    
    echo "WireGuard Status:"
    wg show
fi

exec /app/.venv/bin/uvicorn api:app --host 0.0.0.0 --port 8008
