#!/usr/bin/with-contenv sh
cd /app
# Restore default gateway if missing (linuxserver/wireguard might strip it)
# specific to Docker bridge networks where gateway is usually X.Y.Z.1
GATEWAY=$(ip route show | grep 'default' | awk '{print $3}')
if [ -z "$GATEWAY" ]; then
    # Fallback to guessing if default route is missing (rare in Docker)
    GATEWAY=$(ip route show | grep 'link src' | awk '{print $1}' | cut -d/ -f1 | awk -F. '{print $1"."$2"."$3".1"}')
    echo "No default gateway found. Trying to add default via guessed $GATEWAY"
    ip route add default via $GATEWAY || echo "Failed to add default route"
else
    echo "Default gateway found: $GATEWAY"
fi

# Connectivity check
echo "Checking internet connectivity..."
if curl -s --connect-timeout 5 https://google.com > /dev/null; then
    echo "Connectivity check PASSED."
else
    echo "Connectivity check FAILED. The container might not have internet access."
fi

# Bootstrap WireGuard if missing
if ! ip link show wg0 > /dev/null 2>&1; then
    echo "wg0 interface not found. Bootstrapping new WireGuard server..."
    
    # Check for persistent key
    KEY_FILE="/config/server_private.key"
    if [ -f "$KEY_FILE" ]; then
        echo "Loading server private key from $KEY_FILE"
        PRIVATE_KEY=$(cat "$KEY_FILE")
    else
        echo "Generating new server private key and saving to $KEY_FILE"
        PRIVATE_KEY=$(wg genkey)
        # Ensure /config exists (it should, as a volume)
        mkdir -p /config
        echo "$PRIVATE_KEY" > "$KEY_FILE"
    fi
    
    # Create interface manually
    ip link add dev wg0 type wireguard
    ip address add 10.13.13.1/24 dev wg0
    
    # Configure WireGuard
    # Create a temp file for the key because `wg set` expects a file or stdin
    echo "$PRIVATE_KEY" > /tmp/server.key
    wg set wg0 listen-port 51820 private-key /tmp/server.key
    rm /tmp/server.key
    
    ip link set up dev wg0
    echo "wg0 bootstrapped successfully!"
    
    # Enable IP forwarding if not already enabled
    current_forward=$(cat /proc/sys/net/ipv4/ip_forward)
    if [ "$current_forward" != "1" ]; then
        echo "Enabling IP Forwarding..."
        sysctl -w net.ipv4.ip_forward=1 || echo "Warning: Failed to set ip_forward via sysctl. It might be read-only."
    else
        echo "IP Forwarding is ALREADY enabled (likely via Docker sysctls)."
    fi
    
    # Enable NAT/Masquerading to access internet
    echo "Enabling NAT..."
    # Ensure legacy tables are used if available, or just standard iptables
    iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
    iptables -A FORWARD -i wg0 -j ACCEPT
    iptables -A FORWARD -o wg0 -j ACCEPT

    echo "Applied iptables rules. Current NAT rules:"
    iptables -t nat -L -v -n
    
    echo "WireGuard Status:"
    wg show
fi

exec /app/.venv/bin/uvicorn api:app --host 0.0.0.0 --port 8008
