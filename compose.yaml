name: wireguard-api

services:
  # https://hub.docker.com/r/linuxserver/wireguard
  # A VPN node with WireGuard service and an API exposed over 8008 port, based in FastAPI
  app:
    build:
      context: .
      dockerfile: Dockerfile
    image: wireguard-api:latest
    container_name: wireguard_api
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    volumes:
      - /lib/modules:/lib/modules
      - ./config:/config
    networks:
      default:
        aliases:
          - wireguard_api
    ports:
      - "${VPN_PORT:-51820}:${VPN_PORT:-51820}/udp"
      - "${API_PORT:-8008}:${API_PORT:-8008}"
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
      - net.ipv4.ip_forward=1
    environment:
      - API_TOKEN=${API_TOKEN:-default_token_change_me}
      - API_PORT=${API_PORT:-8008}
      - SERVER_PUBLIC_KEY=${SERVER_PUBLIC_KEY:-SERVER_PUB_KEY_PLACEHOLDER}
      - SERVER_ENDPOINT=${SERVER_ENDPOINT:-vpn.example.com:51820}
      - WG_INTERFACE=${WG_INTERFACE:-wg0}
    restart: unless-stopped

networks:
  default:
    name: wireguard_api_subnet
